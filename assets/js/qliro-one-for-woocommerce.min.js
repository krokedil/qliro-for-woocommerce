jQuery((function(e){if("undefined"==typeof qliroOneParams||"yes"!==qliroOneParams.isEnabled)return!1;var o={bodyEl:e("body"),checkoutFormSelector:"form.checkout",preventPaymentMethodChange:!1,selectAnotherSelector:"#qliro-one-select-other",paymentMethodEl:e('input[name="payment_method"]'),init:function(){e(document).ready(o.documentReady),o.bodyEl.on("change",'input[name="payment_method"]',o.maybeChangeToQliroOne),o.bodyEl.on("click",o.selectAnotherSelector,o.changeFromQliroOne),o.bodyEl.on("updated_checkout",o.maybeDisplayShippingPrice),o.renderIframe()},documentReady:function(){0<e('input[name="payment_method"]').length?o.paymentMethod=e('input[name="payment_method"]').filter(":checked").val():o.paymentMethod="qliro_one",qliroOneParams.payForOrder||"qliro_one"!==o.paymentMethod||o.moveExtraCheckoutFields(),o.bodyEl.on("update_checkout",o.updateCheckout),o.bodyEl.on("updated_checkout",o.updatedCheckout)},renderIframe:function(){window.q1Ready=function(e){e.onCustomerInfoChanged(o.updateAddress),e.onValidateOrder(o.placeWooOrder),e.onShippingMethodChanged(o.shippingMethodChanged)},e("#qliro-one-iframe").append(qliroOneParams.iframeSnippet)},updateCheckout:function(){void 0!==window.q1&&window.q1.lock()},updatedCheckout:function(){void 0!==window.q1&&window.q1.onOrderUpdated((function(e){window.q1.unlock()}))},shippingMethodChanged:function(o){e("#qoc_shipping_data").val(JSON.stringify(o)),e("body").trigger("qoc_shipping_option_changed",[o]),e("body").trigger("update_checkout")},changeFromQliroOne:function(i){i.preventDefault(),e(o.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),e.ajax({type:"POST",dataType:"json",data:{qliro_one:!1,nonce:qliroOneParams.change_payment_method_nonce},url:qliroOneParams.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){window.location.href=e.responseJSON.data.redirect}})},maybeChangeToQliroOne:function(){o.preventPaymentMethodChange||"qliro_one"===e(this).val()&&(e(".woocommerce-info").remove(),e(o.checkoutFormSelector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),e.ajax({type:"POST",data:{qliro_one:!0,nonce:qliroOneParams.change_payment_method_nonce},dataType:"json",url:qliroOneParams.change_payment_method_url,success:function(e){},error:function(e){},complete:function(e){window.location.href=e.responseJSON.data.redirect}}))},maybeDisplayShippingPrice:function(){if(!e(".qoc-shipping").length&&"qliro_one"===o.paymentMethod&&"yes"===qliroOneParams.shipping_in_iframe)if(e("#shipping_method input[type='radio']").length)e("#shipping_method input[type='radio']:checked").each((function(){var o=e(this).attr("id"),i=e("label[for='"+o+"']").text();e(".woocommerce-shipping-totals td").html(i),e(".woocommerce-shipping-totals td").addClass("qoc-shipping")}));else{var i=e("#shipping_method input[name='shipping_method[0]']").attr("id"),n=e("label[for='"+i+"']").text();e(".woocommerce-shipping-totals td").html(n),e(".woocommerce-shipping-totals td").addClass("qoc-shipping")}},checkIfQliroOneSelected:function(){return o.paymentMethodEl.length>0&&(o.paymentMethod=o.paymentMethodEl.filter(":checked").val(),"qliro_one"===o.paymentMethod)},moveExtraCheckoutFields:function(){e(".woocommerce-additional-fields").appendTo("#qliro-one-extra-checkout-fields");for(var o=e('form[name="checkout"] input, form[name="checkout"] select, textarea'),i=0;i<o.length;i++){var n=o[i].name;e("table.woocommerce-checkout-review-order-table").find(o[i]).length||-1===e.inArray(n,qliroOneParams.standardWooCheckoutFields)&&(0<e("p#"+n+"_field").length?e("p#"+n+"_field").appendTo("#qliro-one-extra-checkout-fields"):e('input[name="'+n+'"]').closest("p").appendTo("#qliro-one-extra-checkout-fields"))}},updateAddress:function(i){var n,r,t,l,a,s,d="email"in i?i.email:null,c="mobileNumber"in i?i.mobileNumber:null;o.setCustomerType(i),i.address&&(n="firstName"in i.address?i.address.firstName:null,r="lastName"in i.address?i.address.lastName:null,t="street"in i.address?t:null,l="postalCode"in i.address?i.address.postalCode:null,a="city"in i.address?i.address.city:null,s="area"in i.address?i.address.area:null),e("#ship-to-different-address-checkbox").is(":checked")?(null!=d&&e("#shipping_email").val(d),null!=c&&e("#shipping_phone").val(c),null!=n&&e("#shipping_first_name").val(n),null!=r&&e("#shipping_last_name").val(r),null!=t&&e("#shipping_address_1").val(t),null!=l&&e("#shipping_postcode").val(l),null!=a&&e("#shipping_city").val(a),null!=s&&o.setStateField("shipping",s),e("form.checkout").trigger("update_checkout"),e("#shipping_email").change(),e("#shipping_email").blur()):(null!=d&&e("#billing_email").val(d),null!=c&&e("#billing_phone").val(c),null!=n&&e("#billing_first_name").val(n),null!=r&&e("#billing_last_name").val(r),null!=t&&e("#billing_address_1").val(t),null!=l&&e("#billing_postcode").val(l),null!=a&&e("#billing_city").val(a),null!=s&&o.setStateField("billing",s),e("form.checkout").trigger("update_checkout"),e("#billing_email").change(),e("#billing_email").blur())},setCustomerType:function(e){e.organizationNumber?Cookies.set(qliroOneParams.customerTypeCookieName,"business"):Cookies.set(qliroOneParams.customerTypeCookieName,"consumer")},getQliroOneOrder:function(i,n){o.logToFile("onValidateOrder from Qliro triggered"),e.ajax({type:"POST",data:{nonce:qliroOneParams.get_order_nonce},dataType:"json",url:qliroOneParams.get_order_url,success:function(e){},error:function(e){},complete:function(e){o.setAddressData(e.responseJSON.data,n),console.log("getQliroOneOrder completed")}})},setAddressData:function(i,n){0<e("form.checkout #terms").length&&e("form.checkout #terms").prop("checked",!0),console.log(i),e("#billing_first_name").val(i.billingAddress.FirstName),e("#billing_last_name").val(i.billingAddress.LastName),e("#billing_company").val(i.billingAddress.CompanyName),e("#billing_address_1").val(i.billingAddress.Street),e("#billing_address_2").val(i.billingAddress.Street2),e("#billing_city").val(i.billingAddress.City),e("#billing_postcode").val(i.billingAddress.PostalCode),o.setStateField("billing",i.billingAddress.Area),e("#billing_phone").val(i.customer.MobileNumber),e("#billing_email").val(i.customer.Email),e("#ship-to-different-address-checkbox").prop("checked",!0),e("#shipping_first_name").val(i.shippingAddress.FirstName),e("#shipping_last_name").val(i.shippingAddress.LastName),e("#shipping_company").val(i.shippingAddress.CompanyName),e("#shipping_address_1").val(i.shippingAddress.Street),e("#shipping_address_2").val(i.shippingAddress.Street2),e("#shipping_city").val(i.shippingAddress.City),e("#shipping_postcode").val(i.shippingAddress.PostalCode),o.setStateField("shipping",i.shippingAddress.Area),i.billingAddress&&e("#billing_country").val(i.billingAddress.CountryCode),i.shippingAddress&&e("#shipping_country").val(i.shippingAddress.CountryCode),o.submitOrder(n)},setStateField:function(o,i){if(null!=i){var n=e("#".concat(o,"_state"));0!==n.length&&(n.is("select")?n.find("option").each((function(){e(this).text()===i&&n.val(e(this).val())})):n.val(i))}},submitOrder:function(i){e(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),e.ajax({type:"POST",url:qliroOneParams.submitOrder,data:e("form.checkout").serialize(),dataType:"json",success:function(e){console.log(e);try{if("success"!==e.result)throw console.log("submit order - missing success",e),"Result failed";console.log("submit order success",e),o.logToFile('Successfully placed order. Sending "shouldProceed: true" to Qliro.'),i({shouldProceed:!0,errorMessage:""}),clearTimeout(o.timeout)}catch(r){if(console.log("catch error"),console.error(r),e.messages){var n=e.messages.replace(/<\/?[^>]+(>|$)/g,"");console.log("error ",n),o.logToFile("Checkout error | "+n),o.failOrder("submission",n,i)}else o.logToFile("Checkout error | No message"),o.failOrder("submission","Checkout error",i)}},error:function(e){try{o.logToFile("AJAX error | "+JSON.stringify(e))}catch(e){o.logToFile("AJAX error | Failed to parse error message.")}o.failOrder("ajax-error","Internal Server Error",i)}})},failOrder:function(i,n,r){clearTimeout(o.timeout),r({shouldProceed:!1,errorMessage:n}),e("body").trigger("updated_checkout"),e(o.checkoutFormSelector).removeClass("processing"),e(o.checkoutFormSelector).unblock(),e(".woocommerce-checkout-review-order-table").unblock()},placeWooOrder:function(e,i){o.timeout=setTimeout((function(){o.logToFile("Timeout error | Timeout when placing the WooCommerce order"),o.failOrder("timeout-error","Timeout error",i)}),29e3),o.getQliroOneOrder(e,i)},logToFile:function(o){e.ajax({url:qliroOneParams.log_to_file_url,type:"POST",dataType:"json",data:{message:o,nonce:qliroOneParams.log_to_file_nonce}})}};o.init()}));
//# sourceMappingURL=qliro-one-for-woocommerce.min.js.map